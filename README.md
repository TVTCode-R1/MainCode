# MainCode

This repository contains the core implementation of the algorithms presented in the paper “Hierarchical Cooperative Trajectory Planning Coupled with Multi-Agent Reinforcement Learning and Optimal Control for CAVs at Unstructured Intersections”

This project demonstrates a hierarchical framework for Connected Automated Vehicles (CAVs) in unstructured environments. It combines HE-MATD3 (Multi-Agent Reinforcement Learning) for efficient homotopy exploration with an Optimization-based Planner for precise trajectory refinement.

## Repository Structure & Core Modules

The codebase is organized into two independent but logically coupled core modules, following the hierarchical architecture proposed in the paper:

### 1. Upper-Level: MARL Decision Layer

This module implements the HE-MATD3 algorithm, serving as the high-level inference engine.

Function: Utilizes a hybrid reward function and bicycle kinematic models to explore the optimal passing topology (Homotopy Class) in complex unstructured environments.

Output: Generates a coarse trajectory containing the optimal topological decision, rather than the final drivable path.

Key Files:

Agent_Training.py: Core training logic for MARL agents.

Scenario_Test.py: Evaluates generalization capability in scenarios with randomized start/goal positions.

Robustness_Test.py: Stress testing in highly dynamic environments (e.g., swinging obstacles).

### 2. Lower-Level: Optimal Control Layer

This module implements an Iterative Solving Framework, corresponding to the optimization-based solution part of the paper.

Function: Focuses on trajectory refinement. It takes the coarse trajectory from the upper layer as a basis and strictly enforces hard safety constraints.

Core Mechanisms:

Dynamic Corridor Construction: Uses SFC_Construction.py and RSFC_Construction.py to convert non-linear collision constraints (static boundaries and dynamic vehicles) into linear safe corridor constraints.

Iterative Optimization: OCP_Main.py orchestrates the update of corridors and the solving of the NLP problem, converging to the optimal solution through multiple iterations.

Key Files:

OCP_Main.py: The main solver responsible for managing the iterative loop and invoking the optimization algorithm.

SFC_Construction.py & RSFC_Construction.py: Responsible for generating Safe Travel Corridors (STC) and Relative Safe Travel Corridors (RSTC).
## Hierarchical Coupling & Reproduction

These two modules represent the core code implementations of the Upper-Level and Lower-Level, respectively. The complete cooperative planning framework can be reproduced by performing a simple logical coupling based on the paper's methodology:

Training Phase: Depending on the specific scenario requirements, reproduce the mechanism where MARL obtains Trajectory-level Reward feedback by invoking the OCP solver to guide homotopy exploration.

Deployment Phase: Use the coarse trajectory generated by MARL as the Initial Guess input for the OCP solver to perform the final trajectory Refinement.

Researchers can use the core modules provided in this repository to quickly implement this coupling process according to the scenarios they wish to reproduce.

## Usage Guide

Prerequisites

Python >= 3.8

TensorFlow

CasADi & IPOPT

NumPy, Pandas, Matplotlib

Running the Core Implementation
